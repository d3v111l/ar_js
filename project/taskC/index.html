
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WebXR Educational Project</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: Arial, sans-serif; }
        #container { position: relative; width: 100%; height: 100vh; }
        #ui { 
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px;
            max-width: 300px;
        }
        #ar-button { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; padding: 15px 30px; font-size: 18px;
            background: #007bff; color: white; border: none; border-radius: 25px;
            cursor: pointer;
        }
        #status { margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui">
            <h3>WebXR Educational Experience</h3>
            <div id="info">Натисніть кнопку AR для початку</div>
            <div id="status"></div>
        </div>
        <button id="ar-button">Увійти до AR</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        
        // Educational AR Application
        class WebXREducationalApp {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.mlModel = null;
                this.educationalObjects = [];
                this.hitTestSource = null;
                this.reticle = null;
            }
            
            async init() {
                // Initialize Three.js scene
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                
                // Setup renderer with XR support
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                
                document.getElementById('container').appendChild(this.renderer.domElement);
                
                // Add lighting
                const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
                this.scene.add(light);
                
                // Create reticle for hit testing
                this.createReticle();
                
                // Setup ML model for CS students
                await this.loadMLModel();
                
                // Create AR button
                const arButton = ARButton.createButton(this.renderer, {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                document.body.appendChild(arButton);
                
                // Setup XR session events
                this.setupXREvents();
                
                // Setup controllers for interaction
                this.setupControllers();
                
                // Start render loop
                this.renderer.setAnimationLoop(() => this.render());
                
                document.getElementById('info').textContent = 'AR готовий до використання';
            }
            
            createReticle() {
                const geometry = new THREE.RingGeometry(0.15, 0.2, 32);
                geometry.rotateX(-Math.PI / 2);
                const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
                this.reticle = new THREE.Mesh(geometry, material);
                this.reticle.matrixAutoUpdate = false;
                this.reticle.visible = false;
                this.scene.add(this.reticle);
            }
            
            async loadMLModel() {
                try {
                    // Example: Load a pre-trained model for CS students
                    // this.mlModel = await tf.loadLayersModel('./models/educational-model.json');
                    console.log('ML Model loaded successfully');
                    document.getElementById('status').textContent = 'ML модель завантажена';
                } catch (error) {
                    console.log('ML Model not available:', error);
                    document.getElementById('status').textContent = 'ML модель недоступна';
                }
            }
            
            setupXREvents() {
                this.renderer.xr.addEventListener('sessionstart', async () => {
                    console.log('XR session started');
                    document.getElementById('info').textContent = 'AR сесія активна';
                    
                    const session = this.renderer.xr.getSession();
                    const viewerReferenceSpace = await session.requestReferenceSpace('viewer');
                    this.hitTestSource = await session.requestHitTestSource({ space: viewerReferenceSpace });
                });
                
                this.renderer.xr.addEventListener('sessionend', () => {
                    console.log('XR session ended');
                    document.getElementById('info').textContent = 'AR сесія завершена';
                    this.hitTestSource = null;
                });
            }
            
            setupControllers() {
                const controller = this.renderer.xr.getController(0);
                controller.addEventListener('select', () => this.onSelect());
                this.scene.add(controller);
            }
            
            onSelect() {
                if (this.reticle.visible) {
                    // Create educational content at reticle position
                    this.createEducationalContent(this.reticle.matrix);
                }
            }
            
            createEducationalContent(matrix) {
                // Example: Create a geometric shape
                const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                const material = new THREE.MeshLambertMaterial({ 
                    color: Math.random() * 0xffffff 
                });
                const mesh = new THREE.Mesh(geometry, material);
                
                // Set position from hit test matrix
                mesh.position.setFromMatrixPosition(matrix);
                mesh.userData = { type: 'educational', created: Date.now() };
                
                this.scene.add(mesh);
                this.educationalObjects.push(mesh);
                
                // Update UI
                document.getElementById('info').textContent = 
                    `Створено об'єктів: ${this.educationalObjects.length}`;
                
                // ML processing for CS students
                if (this.mlModel) {
                    this.processWithML(mesh);
                }
            }
            
            processWithML(object) {
                // Example ML processing for CS students
                // Could be: object classification, behavior prediction, etc.
                console.log('Processing object with ML model:', object);
            }
            
            updateHitTest(frame) {
                if (!this.hitTestSource) return;
                
                const hitTestResults = frame.getHitTestResults(this.hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const referenceSpace = this.renderer.xr.getReferenceSpace();
                    const hitPose = hit.getPose(referenceSpace);
                    
                    this.reticle.visible = true;
                    this.reticle.matrix.fromArray(hitPose.transform.matrix);
                } else {
                    this.reticle.visible = false;
                }
            }
            
            updateEducationalContent() {
                // Update educational objects (animations, calculations, etc.)
                this.educationalObjects.forEach(obj => {
                    // Example: rotate objects
                    obj.rotation.y += 0.01;
                    
                    // Educational logic here
                    this.processEducationalLogic(obj);
                });
            }
            
            processEducationalLogic(object) {
                // Implement subject-specific educational logic
                // Mathematics: geometric calculations
                // Physics: force simulations
                // Chemistry: molecular interactions
                // Computer Science: algorithm visualization
            }
            
            render() {
                const frame = this.renderer.xr.getFrame();
                
                if (frame) {
                    this.updateHitTest(frame);
                }
                
                this.updateEducationalContent();
                
                // ML processing loop for CS students
                if (this.mlModel && frame) {
                    this.runMLInference();
                }
                
                this.renderer.render(this.scene, this.camera);
            }
            
            runMLInference() {
                // Run ML inference periodically for CS students
                // Example: emotion detection, gesture recognition, etc.
            }
        }
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = new WebXREducationalApp();
                await app.init();
            } catch (error) {
                console.error('Failed to initialize WebXR app:', error);
                document.getElementById('info').textContent = 'Помилка ініціалізації AR';
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.app) {
                window.app.camera.aspect = window.innerWidth / window.innerHeight;
                window.app.camera.updateProjectionMatrix();
                window.app.renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>